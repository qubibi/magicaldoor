<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>"Magical" Door by qubibi</title>
		<meta name="viewport" content="width=device-width">
		<style>
			html, body, .p5Canvas, main {  -webkit-touch-callout: none;  -webkit-user-select: none;  user-select: none; }
			html, body { overflow: hidden; background-color: #000}
			 body {margin:0; padding:0; background-color: #000;}
			.p5Canvas {height:100% !important; width:auto !important; object-fit: cover; }
			main { height:100%; width:100%; display:flex; position:relative; align-items: center; justify-content: center; margin: auto; }
			#back { position: fixed; z-index:99; left: 1.5vh; top: 1.5vh}
			#back img { width: 3vh; }
			#soundonoff { position:absolute; z-index: 199; left:.77vh; bottom:-10.5vh; user-select: none; }
			#soundonoff img {width: 4vh; }
			#qr  { position:absolute; z-index: 199; right:1vh; bottom:1vh; }
			html {
			touch-action: none; /* 全てのタッチ操作を許可 */
			}
			
			/* インタラクション無効化 */
			body.interaction-disabled {
				pointer-events: none;
			}
			body.interaction-disabled #audio-cover {
				pointer-events: all;
			}
			
			/* 音声有効化カバー */
			#audio-cover {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: #999;
				z-index: 1000;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				touch-action: none; /* タッチ操作を完全制御 */
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				user-select: none;
				-webkit-tap-highlight-color: transparent; /* タップハイライトを無効化 */
			}
			
			#cover-content {
				text-align: center;
				color: #000;
				font-family: Arial, sans-serif;
			}
			
			#cover-content h1 {
				font-size: 2rem;
				margin-bottom: 2rem;
				font-weight: normal;
			}
			
			#cover-content p {
				font-size: 1.0rem;
				margin: 0.5rem 0;
			}
			
			#tap-instruction {
				font-size: 1rem;
				margin-top: 3rem;
				opacity: 0.8;
			}
			
			/* カバーが非表示の時 */
			#audio-cover.hidden {
				visibility: hidden;
				pointer-events: none;
				opacity: 0;
				transition: opacity 0.2s ease-out;
			}
		</style>
   <script id="fxhash-snippet">
      //---- do not edit the following code (you can indent as you wish)
      let alphabet = "123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"
      var fxhash = "oo" + Array(49).fill(0).map(_=>alphabet[(Math.random()*alphabet.length)|0]).join('')
      let b58dec = str=>[...str].reduce((p,c)=>p*alphabet.length+alphabet.indexOf(c)|0, 0)
      let fxhashTrunc = fxhash.slice(2)
      let regex = new RegExp(".{" + ((fxhash.length/4)|0) + "}", 'g')
      let hashes = fxhashTrunc.match(regex).map(h => b58dec(h))
      let sfc32 = (a, b, c, d) => {
        return () => {
          a |= 0; b |= 0; c |= 0; d |= 0
          var t = (a + b | 0) + d | 0
          d = d + 1 | 0
          a = b ^ b >>> 9
          b = c + (c << 3) | 0
          c = c << 21 | c >>> 11
          c = c + t | 0
          return (t >>> 0) / 4294967296
        }
      }
      var fxrand = sfc32(...hashes)
      // true if preview mode active, false otherwise
      // you can append preview=1 to the URL to simulate preview active
      var isFxpreview = new URLSearchParams(window.location.search).get('preview') === "1"
      // call this method to trigger the preview
      function fxpreview() {
        console.log("fxhash: TRIGGER PREVIEW")
      }
      //---- /do not edit the following code
    </script>
		<script defer src="./lib/p5.js"></script>		
		<script defer src="./lib/Pizzicato_qbb.js"></script>
	</head>
	<body class="interaction-disabled">
		<!-- デバッグ用状態表示 -->
		<div id="debug-status" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; font-family: monospace; font-size: 12px; z-index: 10000;">
			<div>is_sound: <span id="debug-sound">false</span></div>
			<div>oto_setup_count: <span id="debug-oto-count">0</span></div>
			<div>group_effects: <span id="debug-group-effects">0</span></div>
			<div>is_interaction_enabled: <span id="debug-enabled">false</span></div>
			<div>is_interaction_ready: <span id="debug-ready">false</span></div>
			<div>is_first_touch_done: <span id="debug-done">false</span></div>
			<div>early_tap_blocked: <span id="debug-blocked">false</span></div>
			<div>first_valid_tap: <span id="debug-valid-tap">false</span></div>
			<div>touch_count: <span id="debug-touch-count">0</span></div>
			<div>nyu.now_ty: <span id="debug-now-ty">0</span></div>
			<div>nyu.diff_ty: <span id="debug-diff-ty">0</span></div>
			<div>native_touchstart: <span id="debug-native-touchstart">0</span></div>
			<div>touchcancel_count: <span id="debug-touchcancel">0</span></div>
			<div>debug_touch_y: <span id="debug-touch-y">-</span></div>
			<div>nyu_kihon_called: <span id="debug-nyu-kihon">0</span></div>
		</div>
		<script src="./lib/inobounce.min.js"></script>
<!-- 
Music 
Mysz-Gmeiner M 3 Side B – Der Nussbaum (Schumann)
All recordings are from Grammophon ca. 1928
Public Domain Mark 1.0
https://archive.org/details/mysz-gmeiner-m-3-side-b/12+–+Mysz-Gmeiner+M+3+Side+B+–+Der+Nussbaum+(Schumann)+[185+bk%2C+62533].wav
 -->
		
		<!-- 音声有効化カバー -->
		<div id="audio-cover">
			<div id="cover-content">
				<p>Magical Door by qubibi<br>
				*Audio enabled<br>
				*Interaction required<br>
				
			</div>
		</div>
		
		<div id="soundonoff"><a href="javascript:f_usertouchstart()"><img src="./imptmp/sound_on.svg"></a></div>

		<main>
		</main>
		<script defer src="./codetmp/userandhtml.js"></script>
		<script src="./code/import.js"></script>
<script>
  // カバー処理の状態管理
  var isCoverProcessing = false;
  var coverRemoveTime = 0;
  var lastEarlyTapBlocked = false;
  var firstValidTapDetected = false;
  var native_touchstart_count = 0;
  var touchcancel_count = 0;
  
  // 音声カバーのmousedown/touchstart処理
  function handleCoverInteraction(e) {
    e.preventDefault(); // デフォルト動作を防ぐ
    e.stopPropagation(); // イベントの伝播を止める
    // stopImmediatePropagationを削除（iOS Chromeの問題回避）
    
    // 二重実行防止
    if (isCoverProcessing) return;
    isCoverProcessing = true;
    coverRemoveTime = Date.now();
    
    // iOS Chrome判定
    var isIOSChrome = /CriOS/.test(navigator.userAgent);
    if (isIOSChrome) {
      console.log("iOS Chrome detected - handling audio immediately");
    }
    
    f_usertouchstart();
    
    // カバーを視覚的に非表示（DOMからは削除しない）
    document.getElementById('audio-cover').classList.add('hidden');
    
    // カバーが消えたら、touchmoveのブロックを解除
    audioCover.removeEventListener('touchmove', blockCoverMove);
    audioCover.removeEventListener('mousemove', blockCoverMove);
    
    // 290ms後はタイマーで何もしない（最初のタップを待つだけ）
    console.log("Cover removed, waiting for first tap after 290ms");
  }
  
  // カバー上のタッチムーブを完全に無効化
  function blockCoverMove(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  var audioCover = document.getElementById('audio-cover');
  
  // コンテキストメニューを完全に無効化
  audioCover.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });
  
  audioCover.addEventListener('mousedown', handleCoverInteraction);
  audioCover.addEventListener('touchstart', handleCoverInteraction, {passive: false});
  audioCover.addEventListener('touchmove', blockCoverMove, {passive: false});
  audioCover.addEventListener('mousemove', blockCoverMove);
  
  // 290ms後の最初のタップ/クリックでインタラクション開始
  function handleFirstInteraction(e) {
    // カバー除去後290ms以内のタップは無視
    if (coverRemoveTime > 0 && (Date.now() - coverRemoveTime) < 290) {
      e.preventDefault();
      e.stopPropagation();
      lastEarlyTapBlocked = true;
      console.log("Early tap blocked: " + (Date.now() - coverRemoveTime) + "ms after cover removal");
      // 1秒後にフラグをリセット
      setTimeout(function() {
        lastEarlyTapBlocked = false;
      }, 1000);
      return false;
    }
    
    // 290ms後の最初のタップでインタラクション開始
    if (coverRemoveTime > 0 && !is_interaction_enabled && (Date.now() - coverRemoveTime) >= 290) {
      document.body.classList.remove('interaction-disabled');
      is_interaction_enabled = true;
      is_interaction_ready = true;
      is_first_touch_done = true;
      firstValidTapDetected = true;
      console.log("First valid interaction after 290ms - interactions enabled!");
    }
  }
  
  // タッチとマウス両方に対応
  document.addEventListener('touchstart', handleFirstInteraction, {passive: false, capture: true});
  document.addEventListener('mousedown', handleFirstInteraction, {passive: false, capture: true});
  
  // touchmoveがブロックされないように明示的に処理を追加
  document.addEventListener('touchmove', function(e) {
    // インタラクションが有効になったら、touchmoveは通過させる
    if (is_interaction_enabled && is_first_touch_done) {
      // 何もせずに通過させる（captureフェーズでも止めない）
      return;
    }
  }, {passive: false, capture: true});
  
  // ネイティブtouchstartカウント（デバッグ用）
  document.addEventListener('touchstart', function(e) {
    native_touchstart_count++;
  }, {passive: true});
  
  // touchcancelイベントの監視
  document.addEventListener('touchcancel', function(e) {
    touchcancel_count++;
    console.log('touchcancel detected!');
  }, {passive: true});
  
  document.documentElement.addEventListener('touchstart', function (e) {
  if (e.touches.length >= 2) {e.preventDefault();}
  }, {passive: false});
  var t = 0;
  document.documentElement.addEventListener('touchend', function (e) {
  var now = new Date().getTime();
  if ((now - t) < 350){
    e.preventDefault();
  }
  t = now;
  }, false);
  
  // デバッグ表示を100ms毎に更新
  setInterval(function() {
    document.getElementById('debug-sound').textContent = is_sound;
    
    // oto.setupCountを表示
    var otoCount = 0;
    if (typeof oto !== 'undefined' && oto.setupCount !== undefined) {
      otoCount = oto.setupCount;
    }
    document.getElementById('debug-oto-count').textContent = otoCount;
    
    // au_musicgroupのエフェクト数を確認
    var groupEffectsCount = 0;
    if (typeof au_musicgroup !== 'undefined' && au_musicgroup && au_musicgroup.effects) {
      groupEffectsCount = au_musicgroup.effects.length;
    }
    document.getElementById('debug-group-effects').textContent = groupEffectsCount;
    
    document.getElementById('debug-enabled').textContent = is_interaction_enabled;
    document.getElementById('debug-ready').textContent = is_interaction_ready;
    document.getElementById('debug-done').textContent = is_first_touch_done;
    document.getElementById('debug-blocked').textContent = lastEarlyTapBlocked;
    document.getElementById('debug-valid-tap').textContent = firstValidTapDetected;
    
    // 新しいデバッグ値の表示
    document.getElementById('debug-touch-count').textContent = (typeof touch_count !== 'undefined') ? touch_count : 0;
    document.getElementById('debug-now-ty').textContent = (typeof nyu !== 'undefined' && nyu && nyu.now_ty !== undefined) ? nyu.now_ty.toFixed(2) : 0;
    document.getElementById('debug-diff-ty').textContent = (typeof nyu !== 'undefined' && nyu && nyu.diff_ty !== undefined) ? nyu.diff_ty.toFixed(2) : 0;
    document.getElementById('debug-native-touchstart').textContent = native_touchstart_count;
    document.getElementById('debug-touchcancel').textContent = touchcancel_count;
    document.getElementById('debug-touch-y').textContent = (window.debug_touch_y !== undefined) ? window.debug_touch_y.toFixed(2) : '-';
    document.getElementById('debug-nyu-kihon').textContent = window.debug_nyu_kihon_called || 0;
  }, 100);
</script>
	</body>
</html>